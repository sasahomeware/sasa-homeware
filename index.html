<!DOCTYPE html>
<html>
<head>
  <title>SASA Interiors AR Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.4.0/model-viewer.min.js"></script>
  <style>
    #tiling-scale-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: #007bff;
      cursor: pointer;
      border: 2px solid white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    #tiling-scale-slider::-moz-range-thumb {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: #007bff;
      cursor: pointer;
      border: 2px solid white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
  </style>
</head>
<body>

  <model-viewer
      id="main-viewer"
      ar
      ar-modes="webxr scene-viewer quick-look"
      camera-controls
      shadow-intensity="1"
      style="width: 100%; height: 700px;">
      <button slot="ar-button" id="ar-button" style="background-color: white; border-radius: 4px; border: 1px solid black; position: absolute; bottom: 16px; right: 16px; padding: 10px 15px; cursor: pointer;">
          View in your room
      </button>
  </model-viewer>

  <div id="material-controls" style="padding: 16px; background-color: #f9f9f9; border-top: 1px solid #ddd; font-family: Arial, sans-serif;">
    <div style="display: flex; align-items: center; gap: 24px; flex-wrap: wrap;">
        <div style="display: flex; align-items: center; gap: 16px;">
            <span style="font-size: 14px; font-weight: 500; color: #555;">Materials:</span>
            <div id="fabric-controls" style="display: flex; gap: 12px; align-items: center;"></div>
        </div>
        <div style="display: flex; align-items: center; gap: 12px;">
            <span style="font-size: 14px; font-weight: 500; color: #555;">Tiling Scale:</span>
            <div style="display: flex; align-items: center; gap: 8px;">
                <input id="tiling-scale-slider" type="range" min="0.1" max="5.0" step="0.1" value="1.0" 
                       style="width: 120px; height: 6px; background: #ddd; border-radius: 3px; outline: none; cursor: pointer; -webkit-appearance: none; appearance: none; background: linear-gradient(to right, #007bff 0%, #007bff 0%, #ddd 0%, #ddd 100%);">
                <span id="texture-scale-display" style="font-size: 12px; color: #666; min-width: 30px; text-align: center;">1.0</span>
            </div>
        </div>
    </div>
  </div>

  <script>
    const modelViewer = document.querySelector('#main-viewer');
    const params = new URLSearchParams(window.location.search);
    const glbSrc = params.get('glb');

    let currentTextureScale = 1.0;

    // Load initial model if provided
    if (glbSrc) {
        modelViewer.src = glbSrc;
    }

    // Clean up URL without refreshing
    window.history.replaceState(
        {}, 
        document.title, 
        window.location.pathname
    );

    const fabricSets = {
        'leather': {
            name: 'Brown Leather',
            color: './Leather037_2K-PNG_Color.png',
            normal: './Leather037_2K-PNG_NormalGL.png',
            roughness: './Leather037_2K-PNG_Roughness.png',
        },
        'carpet': {
            name: 'Carpet',
            color: './Carpet016_4K-PNG/Carpet016_4K-PNG_Color.png',
            normal: './Carpet016_4K-PNG/Carpet016_4K-PNG_NormalGL.png',
            roughness: './Carpet016_4K-PNG/Carpet016_4K-PNG_Roughness.png',
        }
    };

    function applyPBRTextureSet(material, textures) {
        if (textures.color) material.pbrMetallicRoughness.baseColorTexture.setTexture(textures.color);
        if (textures.normal) material.normalTexture.setTexture(textures.normal);
        if (textures.roughness) material.pbrMetallicRoughness.metallicRoughnessTexture.setTexture(textures.roughness);
        if (textures.ao) material.occlusionTexture.setTexture(textures.ao);
        
        updateAllMaterialScales();
    }

    function setTextureScale(textureInfo, scale) {
        if (textureInfo && textureInfo.texture && textureInfo.texture.sampler) {
            textureInfo.texture.sampler.setScale({ u: scale, v: scale });
        }
    }

    function updateAllMaterialScales() {
        const model = modelViewer.model;
        if (!model) return;
        
        model.materials.forEach(material => {
            setTextureScale(material.pbrMetallicRoughness.baseColorTexture, currentTextureScale);
            setTextureScale(material.normalTexture, currentTextureScale);
            setTextureScale(material.pbrMetallicRoughness.metallicRoughnessTexture, currentTextureScale);
            setTextureScale(material.occlusionTexture, currentTextureScale);
        });
        
        const scaleDisplay = document.getElementById('texture-scale-display');
        if (scaleDisplay) {
            scaleDisplay.textContent = `${currentTextureScale.toFixed(1)}`;
        }
    }
    
    function updateTextureScale() { updateAllMaterialScales(); }

    function addMaterialControls() {
        const model = modelViewer.model;
        if (!model) return;

        const fabricControls = document.getElementById('fabric-controls');
        fabricControls.innerHTML = '';

        for (const key in fabricSets) {
            const fabricSet = fabricSets[key];
            
            // Create material swatch container
            const swatchContainer = document.createElement('div');
            swatchContainer.style.cssText = `position: relative; display: inline-block;`;
            
            // Create circular swatch button
            const fabricSwatch = document.createElement('button');
            fabricSwatch.style.cssText = `
                width: 50px;
                height: 50px;
                border-radius: 50%;
                border: 3px solid #ddd;
                cursor: pointer;
                background-image: url('${fabricSet.color}');
                background-size: cover;
                background-position: center;
                background-repeat: no-repeat;
                transition: border-color 0.2s ease, transform 0.1s ease;
                outline: none;
            `;
            
            // Add hover effect
            fabricSwatch.addEventListener('mouseenter', () => {
                if (fabricSwatch.style.borderColor !== 'rgb(0, 123, 255)') {
                    fabricSwatch.style.borderColor = '#999';
                    fabricSwatch.style.transform = 'scale(1.05)';
                }
            });
            
            fabricSwatch.addEventListener('mouseleave', () => {
                if (fabricSwatch.style.borderColor !== 'rgb(0, 123, 255)') {
                    fabricSwatch.style.borderColor = '#ddd';
                    fabricSwatch.style.transform = 'scale(1)';
                }
            });
            
            // Create tooltip
            const tooltip = document.createElement('div');
            tooltip.innerText = fabricSet.name;
            tooltip.style.cssText = `
                position: absolute;
                bottom: 65px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(0, 0, 0, 0.8);
                color: white;
                padding: 6px 10px;
                border-radius: 4px;
                font-size: 12px;
                white-space: nowrap;
                opacity: 0;
                pointer-events: none;
                transition: opacity 0.2s ease;
                z-index: 1000;
            `;
            
            // Add triangle pointer for tooltip
            const tooltipArrow = document.createElement('div');
            tooltipArrow.style.cssText = `
                position: absolute;
                top: 100%;
                left: 50%;
                transform: translateX(-50%);
                border-left: 5px solid transparent;
                border-right: 5px solid transparent;
                border-top: 5px solid rgba(0, 0, 0, 0.8);
            `;
            tooltip.appendChild(tooltipArrow);
            
            // Show/hide tooltip on hover
            swatchContainer.addEventListener('mouseenter', () => {
                tooltip.style.opacity = '1';
            });
            
            swatchContainer.addEventListener('mouseleave', () => {
                tooltip.style.opacity = '0';
            });
            
            // Handle click to apply texture
            fabricSwatch.onclick = async () => {
                try {
                    console.log(`Loading textures for: ${fabricSet.name}`);
                    
                    // Load textures on-demand
                    const [color, normal, roughness, ao] = await Promise.all([
                        modelViewer.createTexture(fabricSet.color),
                        modelViewer.createTexture(fabricSet.normal),
                        modelViewer.createTexture(fabricSet.roughness),
                        fabricSet.ao ? modelViewer.createTexture(fabricSet.ao) : Promise.resolve(null)
                    ]);
                    
                    const textures = { color, normal, roughness, ao };
                    
                    // Apply to all materials
                    model.materials.forEach(material => {
                        applyPBRTextureSet(material, textures);
                    });

                    // Update swatch selection styles
                    fabricControls.querySelectorAll('button').forEach(btn => {
                        btn.style.borderColor = '#ddd';
                        btn.style.transform = 'scale(1)';
                    });
                    fabricSwatch.style.borderColor = '#007bff';
                    fabricSwatch.style.transform = 'scale(1)';
                    
                    console.log(`Applied textures for: ${fabricSet.name}`);
                } catch (error) {
                    console.error(`Failed to load textures for ${fabricSet.name}:`, error);
                }
            };
            
            // Assemble the swatch
            swatchContainer.appendChild(fabricSwatch);
            swatchContainer.appendChild(tooltip);
            fabricControls.appendChild(swatchContainer);
        }
        
        const tilingSlider = document.getElementById('tiling-scale-slider');
        if (tilingSlider) {
            tilingSlider.addEventListener('input', (e) => {
                currentTextureScale = parseFloat(e.target.value);
                updateTextureScale();
            });
        }
    }

    modelViewer.addEventListener('load', () => {
        const model = modelViewer.model;
        if (!model) return;

        console.log('Model loaded. Setting up material controls...');
        addMaterialControls();
    }, { once: true });



  </script>

</body>
</html>
